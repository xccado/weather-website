<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能天气查询</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="search-box">
            <input type="text" id="locationInput" placeholder="输入地址或点击定位">
            <button onclick="getLocation()">定位</button>
            <button onclick="searchWeather()">查询</button>
        </div>
        
        <div class="weather-card">
            <div class="weather-header">
                <h2 id="location">当前位置：正在获取...</h2>
                <p id="currentTime"></p>
            </div>
            <div class="weather-content">
                <div class="main-info">
                    <div class="temperature">
                        <span id="temperature">--</span><span class="unit">°C</span>
                    </div>
                    <div class="weather-status">
                        <span id="description">--</span>
                    </div>
                </div>
                <div class="additional-info">
                    <div class="info-item">
                        <span class="label">体感温度</span>
                        <span id="apparentTemperature" class="value">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">湿度</span>
                        <span id="humidity" class="value">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">风速</span>
                        <span id="windSpeed" class="value">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">降水量</span>
                        <span id="precipitation" class="value">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取用户地理位置
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        getLocalWeather(position.coords.latitude, position.coords.longitude);
                    },
                    error => {
                        console.error('定位失败:', error);
                        alert('定位失败，请手动输入地址');
                    }
                );
            } else {
                alert('您的浏览器不支持地理定位');
            }
        }

        // 获取天气数据
        async function getLocalWeather(lat, lng) {
            try {
                const response = await fetch(`/api/weather?lat=${lat}&lng=${lng}`);
                const data = await response.json();
                updateWeatherUI(data);
            } catch (error) {
                console.error('获取天气失败:', error);
            }
        }

        // 更新界面
        function updateWeatherUI(data) {
            document.getElementById('location').textContent = `当前位置：${data.result.place.name}`;
            document.getElementById('temperature').textContent = data.result.realtime.temperature;
            document.getElementById('description').textContent = data.result.realtime.skyconDesc;
            
            const updateTime = new Date(data.result.updateTime).toLocaleString();
            document.getElementById('currentTime').textContent = `更新时间：${updateTime}`;

            document.getElementById('apparentTemperature').textContent = 
                `${data.result.realtime.apparent_temperature}°C`;
            document.getElementById('humidity').textContent = 
                `${(data.result.realtime.humidity * 100).toFixed(1)}%`;
            document.getElementById('windSpeed').textContent = 
                `${data.result.realtime.wind.speed.toFixed(1)}m/s`;
            document.getElementById('precipitation').textContent = 
                `${data.result.realtime.precipitation.local.intensity.toFixed(1)}mm`;
        }

        // 搜索天气
        async function searchWeather() {
            const location = document.getElementById('locationInput').value;
            if (!location) return;

            try {
                const response = await fetch(`/api/location?address=${encodeURIComponent(location)}`);
                const { lat, lng } = await response.json();
                getLocalWeather(lat, lng);
            } catch (error) {
                console.error('位置查询失败:', error);
            }
        }

        // 初始加载时自动定位
        window.onload = getLocation;
    </script>
</body>
</html>